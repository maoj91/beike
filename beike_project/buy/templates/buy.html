<!DOCTYPE HTML>
<html lang="zh">

<head>
    <meta name="viewport" content="width=device-width ,  user-scalable=no">
    <meta charset="UTF-8">

    <!-- jquery library -->
    <link rel="stylesheet" type="text/css" href="/static/jquery/jquery.mobile-1.4.2.css">
    <script src="/static/jquery/jquery-1.8.3.js "></script>
    <script src="/static/jquery/jquery.mobile-1.4.2.js"></script>

    <!--js library for s3 upload-->
    <script src="/static/lodash.js"></script>
    <script type="text/javascript" src="/static/s3upload.js"></script>
    <script src="/static/exif.js"></script>
    <script src="/static/binaryajax.js"></script>

    <!-- beike customized css and js -->
    <link rel="stylesheet" type="text/css" href="/static/mystyle.css">
    <link rel="stylesheet" type="text/css" href="/static/me.css">
    <link rel="stylesheet" type="text/css" href="/static/buy.css">
    <link rel="stylesheet" type="text/css" href="/static/sell.css">
    <script src="/static/buy.js"></script>
    <script src="/static/sell.js"></script>

</head>

<body>
    <div data-role="page">
        <div data-role="header" data-position="fixed">
            <img style="width:100%;height:100%; max-width: 680px;" src="/static/images/nearby_buy_posts/header.png" />
        </div>
        <div id="buy-list" data-role="main">
            <div>
                <ul id="postList" data-role="listview">
                </ul>
            </div>
            <script type="text/javascript">
            var pageNum = 1;
            var current_position;
            var hasMore = true;

            var postLoader = (function($, undefined) {
                var pub = {};
                pub.init = function() {
                    //Refresh the posts when scrolling to the bottom
                    $(window).live("hitBottom",
                        function() {
                            pub.getAndDisplayPosts();
                        });
                };

                pub.getAndDisplayPosts = function(position) {
                    //Starting loading animation
                    $('#load-more').show();
                    //Get posts and add success callback using then
                    getPosts(position).then(function() {
                        //Stop loading animation on success
                        // $('#load-more').hide();
                    });
                };

                function getPosts(position) {
                    //Get posts via ajax
                    return $.ajax({
                        type: "get",
                        url: "/buy/get_posts_by_page",
                        dataType: "json",
                        data: {
                            pageNum: pageNum,
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        }
                    }).then(function(data) {
                        displayPosts(data);
                    });
                }

                function displayPosts(posts) {
                    var postList = $("#postList");
                    var i = 0,
                        len = posts.length;
                    if (len == 0) {
                        hasMore = false;
                        $('#load-more').hide();
                    }
                    //process posts data
                    for (; i < len; i++) {
                        var d = new Date(posts[i]["date_published"]);
                        var template = '<li><a href="/detail/buy/' + posts[i]['post_id'] + '"><span><img width="20" height="20" src="/static/images/nearby_buy_posts/request_logo.png" /> ' +
                            posts[i]["title"] + '<br/>$' + posts[i]["min_price"] + ' - $' +
                            posts[i]["max_price"] + '</span>    <span>' +
                            '</span><span style="float: right; ">' + +d.getMonth() + '-' + d.getDate() + '</span></a></li>'
                        postList.append(template);
                    }
                    postList.listview("refresh");
                }
                return pub;
            }(jQuery));

            function getCurrentPositionDeferred(options) {
                var deferred = $.Deferred();
                navigator.geolocation.getCurrentPosition(deferred.resolve, deferred.reject, options);
                return deferred.promise();
            };


            $(document).live('pageshow', function() {
                postLoader.init();
                getCurrentPositionDeferred({
                    enableHighAccuracy: true
                }).done(function(position) {
                    current_position = position;
                    postLoader.getAndDisplayPosts(position);
                }).fail(function() {
                   console.log("getCurrentPosition call failed")
                }).always(function() {
                    //do nothing
                });
            });


            $(document).scroll(function() {
                if ($(document).height() > $(window).height() && hasMore) {
                    if ($(window).scrollTop() >= $(document).height() - $(window).height() - 100) {
                        pageNum++;
                        if (typeof current_position !== 'undefined') {
                            postLoader.getAndDisplayPosts(current_position);
                        }
                    }
                }
            });
            </script>
        </div>
        <div id="load-more" style="vertical-align:middle; text-align:center; display:none">
            <img width="50px" height="50px" src="/static/images/general/loading_green.gif" />
        </div>
        <div data-role="footer" data-position="fixed">
            <img style="width:100%;height:100%; max-width: 680px;" src="/static/images/nearby_buy_posts/footer.png" />
        </div>
    </div>

</body>

</html>