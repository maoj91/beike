function getCurrentPositionDeferred(e){var a=$.Deferred();return navigator.geolocation.getCurrentPosition(a.resolve,a.reject,e),a.promise()}function formatDistance(e){return e>1e3&&(e=(e/1e3).toFixed(2)+"k"),e}function formatPrice(e){var a=parseFloat(e),t=a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");return t.indexOf(".")<0&&(t+=".00"),t.indexOf(".")==t.length-2&&(t+="0"),t}function convert_state(e,a){var e=e.toUpperCase(),t=new Array({name:"Alabama",abbrev:"AL"},{name:"Alaska",abbrev:"AK"},{name:"Arizona",abbrev:"AZ"},{name:"Arkansas",abbrev:"AR"},{name:"California",abbrev:"CA"},{name:"Colorado",abbrev:"CO"},{name:"Connecticut",abbrev:"CT"},{name:"Delaware",abbrev:"DE"},{name:"Florida",abbrev:"FL"},{name:"Georgia",abbrev:"GA"},{name:"Hawaii",abbrev:"HI"},{name:"Idaho",abbrev:"ID"},{name:"Illinois",abbrev:"IL"},{name:"Indiana",abbrev:"IN"},{name:"Iowa",abbrev:"IA"},{name:"Kansas",abbrev:"KS"},{name:"Kentucky",abbrev:"KY"},{name:"Louisiana",abbrev:"LA"},{name:"Maine",abbrev:"ME"},{name:"Maryland",abbrev:"MD"},{name:"Massachusetts",abbrev:"MA"},{name:"Michigan",abbrev:"MI"},{name:"Minnesota",abbrev:"MN"},{name:"Mississippi",abbrev:"MS"},{name:"Missouri",abbrev:"MO"},{name:"Montana",abbrev:"MT"},{name:"Nebraska",abbrev:"NE"},{name:"Nevada",abbrev:"NV"},{name:"New Hampshire",abbrev:"NH"},{name:"New Jersey",abbrev:"NJ"},{name:"New Mexico",abbrev:"NM"},{name:"New York",abbrev:"NY"},{name:"North Carolina",abbrev:"NC"},{name:"North Dakota",abbrev:"ND"},{name:"Ohio",abbrev:"OH"},{name:"Oklahoma",abbrev:"OK"},{name:"Oregon",abbrev:"OR"},{name:"Pennsylvania",abbrev:"PA"},{name:"Rhode Island",abbrev:"RI"},{name:"South Carolina",abbrev:"SC"},{name:"South Dakota",abbrev:"SD"},{name:"Tennessee",abbrev:"TN"},{name:"Texas",abbrev:"TX"},{name:"Utah",abbrev:"UT"},{name:"Vermont",abbrev:"VT"},{name:"Virginia",abbrev:"VA"},{name:"Washington",abbrev:"WA"},{name:"West Virginia",abbrev:"WV"},{name:"Wisconsin",abbrev:"WI"},{name:"Wyoming",abbrev:"WY"}),i=!1;return $.each(t,function(t,o){if("name"==a){if(o.abbrev==e)return i=o.name,!1}else if("abbrev"==a&&o.name.toUpperCase()==e)return i=o.abbrev,!1}),i}function chooseCondition(e){if(e>=0&&4>e)for(i=0;4>i;i++)i==e?($("#condition-"+i).hide(),$("#condition-"+i+"-clicked").show(),$("#condition-slider").val(e)):($("#condition-"+i).show(),$("#condition-"+i+"-clicked").hide())}function toggleKeyword(){$(".search-bar").toggleClass("search-keyword"),$(".search-bar").hasClass("search-keyword")?setTimeout(function(){$("#sellPostKeyword").focus()},600):postLoader.refreshPosts()}function toggleLocation(){$(".search-bar").toggleClass("search-location"),$(".search-bar").hasClass("search-location")?setTimeout(function(){$("#zipcode").focus()},600):postLoader.refreshPosts()}function toggleCategory(){$(".search-category-box").toggleClass("search-category"),$(".search-category-box").hasClass("search-category")||postLoader.refreshPosts()}function validateUserInfo(){return $("#user_info_form").validate({rules:{user_email:{required:!0,email:!0,remote:{url:"check_email",type:"post",async:!1}}},messages:{user_email:{email:"该email格式不对",remote:"该email已经被使用"}}}),$("#username_input").val($("#username").val()),$("#email_input").val($("#user_email").val()),$("#user_info_form").valid()}var a,locUtil=function(){var e=null,a={latitude:null,longitude:null,city:null,state:null,zipcode:null},t=function(e){console.log(e)},i=function(e){var a=$.Deferred();return navigator.geolocation.getCurrentPosition(a.resolve,a.reject,e),a.promise()},o=function(e,i){a.zipcode=e,$.ajax({type:"get",url:"/user/get_info/get_latlong_by_zipcode",dataType:"json",data:{zipcode:e}}).then(function(e){a.city=e.city,a.state=convert_state(e.state,"abbrev"),a.latitude=e.latitude,a.longitude=e.longitude,i&&void 0!==i.apply?i.apply(null,[a]):t.apply(null,[a])})},n=function(e,i){a.latitude=e.latitude,a.longitude=e.longitude,$.ajax({type:"get",url:"/user/get_info/get_zipcode_by_latlong",dataType:"json",data:{latitude:e.latitude,longitude:e.longitude}}).then(function(e){a.city=e.city,a.state=convert_state(e.state,"abbrev"),a.zipcode=e.zipcode,i&&void 0!==i.apply?i.apply(null,[a]):t.apply(null,[a])})},l=function(a){navigator.geolocation?i({enableHighAccuracy:!0}).done(function(t){e=t,n(t.coords,a)}).fail(function(){console.error("getLocation call failed")}).always(function(){}):console.error("Geolocation is disabled.")},r=function(i){e?i&&void 0!==i.apply?i.apply(null,[a]):t.apply(null,[a]):l(i)};return{refreshLocation:l,getLocByZip:o,getLocation:r}}();$.validator.addMethod("digitonly",function(e){return/^\d+$/.test(e)},"只能包含数字"),$(document).on("pagebeforeshow",function(){var e=navigator.userAgent.toLowerCase();"micromessenger"!=e.match(/MicroMessenger/i)&&$(".header").show()});var gallerySwiper=function(e){function t(){0==d||1==d&&!g?e(".gallery-wrapper").addClass("gallery-no-thumbnails"):e(".gallery-wrapper").removeClass("gallery-no-thumbnails"),0==d?e(".gallery-delete").hide():g&&e(".gallery-delete").show()}function i(a){if(v>d){var i=d,o=a.url,n=e('<div class="gallery-thumbnail-box" onclick="gallerySwiper.select('+d+');"><img class="gallery-thumbnail" src="'+o+'" /><div class="gallery-thumbnail-bar"></div></div>'),l=e('<div class="gallery-image-box"><img class="gallery-image" src="'+o+'" /></div>');d++,u.append(l),f.append(n),e("#image_url"+i).val(a.url),e("#image_width"+i).val(a.width),e("#image_height"+i).val(a.height),$(i),t()}}function o(a,t,i,o){if(c=u.width()/5,"move"!=t||"left"!=i&&"right"!=i)"cancel"==t?r(c*s,h):"end"==t&&("right"==i?n():"left"==i&&l(),e(f.children(":not(.gallery-uploader)").removeClass("selected")[s]).addClass("selected"));else{var d=0;"left"==i?r(c*s+o,d):"right"==i&&r(c*s-o,d)}}function n(){s=Math.max(s-1,0),r(u.width()/5*s,h)}function l(){s=Math.min(s+1,d-1),r(u.width()/5*s,h)}function r(e,a){u.css("-webkit-transition-duration",(a/1e3).toFixed(1)+"s");var t=(0>e?"":"-")+Math.abs(e).toString();u.css("-webkit-transform","translate3d("+t+"px,0px,0px)")}var s,d,c,u,f,p,g,m,v=5,h=500,b={triggerOnTouchEnd:!0,swipeStatus:o,allowPageScroll:"vertical"},y={url:"/s3/upload/",dataType:"json",done:function(e,a){var t={url:a.result.image_url,width:a.result.width,height:a.result.height,orientation:a.result.orientation};i(t)},progressall:function(a,t){var i=parseInt(t.loaded/t.total*100,10);e(".gallery-uploader-input").attr("disabled","true"),m.css("width",i+"%")},fail:function(){alert("照片上传出错，请重试一次")},always:function(){e(".gallery-uploader-input").removeAttr("disabled"),m.css("width","0")}},_=function(e){console.log("gallery init"),s=0,c=e.width(),u=e.children(".gallery-list"),f=e.children(".gallery-thumbnail-list"),d=f.children(":not(.gallery-uploader)").length,g=!1,u.hasClass("gallery-canupload")&&(g=!0,p=e.find(".gallery-uploader-input"),m=e.find(".gallery-progressbar"),p.fileupload(y),a=e),u.swipe(b),$(0),t()},w=function(){if(1==confirm("要删除该照片吗?")){d--;for(var a=s;d>a;a++)e("#image_url"+a).val(e("#image_url"+(a+1)).val()),e("#image_width"+a).val(e("#image_width"+(a+1)).val()),e("#image_height"+a).val(e("#image_height"+(a+1)).val()),e(f.children(":not(.image-uploader)")[a+1]).attr("onclick","gallerySwiper.select("+a+");");e("#image_url"+d).val(""),e("#image_width"+d).val(""),e("#image_height"+d).val(""),u[0].children[s+1].remove(),f.children(".selected").remove(),s==d&&$(s-1),$(s),t()}},$=function(a){if(a>=0&&d-1>=a){var t=a-s;if(a>s&&d>a)for(var i=0;t>i;i++)l();else if(a>=0&&s>a)for(var i=0;-t>i;i++)n();s=a,e(f.children(":not(.gallery-uploader)").removeClass("selected")[a]).addClass("selected")}};return{init:_,select:$,deleteImage:w}}(jQuery),formLoader=function(e){var a,t,i,o,n,l,r={},s=!1,d=!1,c=!1;return r.init=function(r,u){console.log("form init"),locUtil.getLocation(),a=r,t=u?u:e("#"+a+"-form"),e(".form-loc-state1").show(),e(".form-loc-state2").hide(),i=t.find("#latitude"),o=t.find("#longitude"),n=t.find("#zipcode"),l=t.find("#city-name"),chooseCondition(e("#condition-slider").val()),e("input:not([readonly], .gallery-uploader-input), textarea").focusin(function(){e(".footer").toggleClass("bottom"),e(".ui-content").css("margin-bottom","0px")}),e("input:not([readonly], .gallery-uploader-input), textarea").focusout(function(){e(".footer").toggleClass("bottom"),e(".ui-content").css("margin-bottom","50px")}),s=!1,d=!1,c=!1;var f={ignore:"",focusCleanup:!0,rules:{phone_number:"digitonly",zipcode:"digitonly"},errorPlacement:function(a,t){t.attr("placeholder",a.html()),t.addClass("hasError"),"zipcode"===t[0].id&&(e(".ui-page-active").find(".form-loc-state1").hide(),e(".ui-page-active").find(".form-loc-state2").show())}};"buy"===a?t.find("form").validate(f):"sell"===a&&t.find("form").validate(e.extend({submitHandler:function(a){return e(a).valid()&&e("#image_url0").valid()&&a.submit(),!1}},f)),locUtil.getLocation(function(e){n.val(e.zipcode),l.val(e.city+", "+e.state),i.val(e.latitude),o.val(e.longitude)});var p=t.find("#description"),g=t.find("#lengthCounter");g.html(p.val().length+"/300"),p.bind("input propertychange",function(){g.html(p.val().length+"/300")})},r.changeLocation=function(){e(".ui-page-active").find(".form-loc-state1").hide(),e(".ui-page-active").find(".form-loc-state2").show()},r.refreshLocation=function(){locUtil.refreshLocation(function(e){n.val(e.zipcode),l.val(e.city+", "+e.state),i.val(e.latitude),o.val(e.longitude)}),e(".ui-page-active").find(".form-loc-state1").show(),e(".ui-page-active").find(".form-loc-state2").hide()},r.getLocationByZipcode=function(){locUtil.getLocByZip(n.val(),function(e){n.val(e.zipcode),l.val(e.city+", "+e.state),i.val(e.latitude),o.val(e.longitude)}),e(".ui-page-active").find(".form-loc-state1").show(),e(".ui-page-active").find(".form-loc-state2").hide()},r.clickPhoneContact=function(){d?(t.find("#phone-icon").show(),t.find("#phone-icon-clicked").hide(),d=!1,t.find("#phone-checked").val("off"),c?t.find("#phone_number_div").css("display","block"):t.find("#phone_number_div").css("display","none")):(t.find("#phone-icon").hide(),t.find("#phone-icon-clicked").show(),t.find("#phone_number_div").css("display","block"),d=!0,t.find("#phone-checked").val("on"))},r.clickEmailContact=function(){s?(t.find("#email-icon").show(),t.find("#email-icon-clicked").hide(),t.find("#email_div").css("display","none"),s=!1,t.find("#email-checked").val("off")):(t.find("#email-icon").hide(),t.find("#email-icon-clicked").show(),t.find("#email_div").css("display","block"),s=!0,t.find("#email-checked").val("on"))},r.clickSmsContact=function(){c?(t.find("#sms-icon").show(),t.find("#sms-icon-clicked").hide(),d?t.find("#phone_number_div").css("display","block"):t.find("#phone_number_div").css("display","none"),c=!1,e("#sms-checked").val("off")):(t.find("#sms-icon").hide(),t.find("#sms-icon-clicked").show(),t.find("#phone_number_div").css("display","block"),c=!0,t.find("#sms-checked").val("on"))},r}(jQuery);$(document).delegate("#buy-form","pagebeforeshow",function(){formLoader.init("buy")}),$(document).delegate("#buy-form","pageshow",function(){}),$(document).delegate("#sell-form","pagebeforeshow",function(){formLoader.init("sell"),gallerySwiper.init($("#sell-form-gallery"))});var postLoader=function(e,a){var t,i,o,n,l,r,s,d,c,u=e(document),f=e(window),p=0,g=null,m=null,v=function(a){t=a,console.log(t+" init"),i=e("#"+t+"-list"),o=i.children(".post-list1"),n=i.children(".post-list2"),l=i.find(".post-load-more").show(),s=i.find(".num-per-page").val(),h(),locUtil.getLocation(function(e){c=e,b()}),e(document).on("scrollstop",function(){b()})},h=function(){slot_pos=0,r=1,d=!0,o.empty(),n.empty()},b=function(){d&&"undefined"!=typeof c&&f.scrollTop()>=u.height()-f.height()-200&&y()},y=function(){return e.ajax({type:"get",url:"/"+t+"/get_posts_by_page",dataType:"json",data:{pageNum:r,latitude:c.latitude,longitude:c.longitude,category:g,keyword:m}}).then(function(e){_(e)})},_=function(i){var c=e(""),u=e(""),f=0,g=i.length;for(s>g?(d=!1,l.hide()):(d=!0,r++),f=0;g>f;f++){var m,v,h,b=formatDistance(i[f].distance);if("sell"===t){if(v=jQuery.parseJSON(i[f].image_info),!(v.length>0)){image_info=a;continue}image_info=v[0],h='<img class="post-image" src="'+image_info.image_url+'" />',m=formatPrice(i[f].price)}else"buy"===t&&(h="",m=formatPrice(i[f].max_price));h='<div class="post-item-box"><a class="post-item" href="/detail/'+t+"/"+i[f].post_id+'" data-transition="slide"><div><img class="post-icon" src="/static/images/general/'+t+'_icon_40.png" /><span class="post-title">'+i[f].title+"</span></div>"+h+'<div class="post-price"><span class="post-currency">$&nbsp;</span>'+m+'</div><div class="post-distance">距离你 '+b+" miles</div></a></div>",p%2===0?c.after(e(h)):u.after(e(h)),p++}o.append(c),n.append(u)},w=function(){},$=function(a){e("body").pagecontainer("change","/detail/"+t+"/"+a)},L=function(){e("#popupBasic-popup").removeClass("ui-popup-active"),e("#popupBasic-popup").addClass("ui-popup-hidden"),e("#popupBasic-popup").addClass("ui-popup-truncate"),g=e('input[name="category"]:checked').val(),m=e("#sellPostKeyword").val(),locUtil.getLocByZip(e("#zipcode").val(),function(e){c=e,h(),b()})};return{init:v,refreshPosts:L,loadPage:w,changePage:$}}(jQuery);$(document).delegate("#nearby-buypost","pagebeforeshow",function(){"buy-detail"!==$(".ui-page-active").attr("id")&&($(document).off("scrollstop"),postLoader.init("buy"))}),$(document).delegate("#nearby-sellpost","pagebeforeshow",function(){"sell-detail"!==$(".ui-page-active").attr("id")&&($(document).off("scrollstop"),postLoader.init("sell"))});var detailLoader=function(e){var a,t,i,o,n=function(n){a=n,t=e("#"+a+"-detail"),i=t.find("#wx_id").val(),o=t.find("#post_id").val();var l=t.find(".detail-price");l.html(formatPrice(l.html())),t.find("#follow-post").on("slidestop",function(){var t=e(this).val();return e.ajax({type:"get",url:"/"+a+"/follow_post",dataType:"json",data:{wx_id:i,post_id:o,follow_option:t}}).then(function(){})}),t.find("#open-close-post").on("slidestop",function(){var t=e(this).val();return e.ajax({type:"get",url:"/"+a+"/open_close_post",dataType:"json",data:{wx_id:i,post_id:o,operation:t}}).then(function(){})}),r(),showPostStatus()},l=function(){var n=t.find("#is_followed").val(),l="",r="";"False"==n?(n="True",l="/static/images/detail/followed.png",r="<p>关注本帖!</p>"):(n="False",r="<p>取消关注！</p>",l="/static/images/detail/not_followed.png"),t.find("#is_followed").val(n),t.find("#follow").attr("src",l),t.find("#follow-popup").html(r),t.find("#follow-popup").popup("open"),setTimeout(function(){t.find("#follow-popup").popup("close")},1e3),e.ajax({type:"get",url:"/"+a+"/follow_post",dataType:"json",data:{wx_id:i,post_id:o,is_followed:n}}).then(function(){})},r=function(){var e=t.find("#is_followed").val();"False"==e?t.find("#follow").attr("src","/static/images/detail/not_followed.png"):t.find("#follow").attr("src","/static/images/detail/followed.png")},s=function(){t.find("#share_msg").show()},d=function(){t.find("#share_msg").hide()};return showPostStatus=function(){var e=t.find("#is_open").val();t.find("#open .ui-btn-text").text("False"==e?"标记为待售":"标记为已售")},togglePostStatus=function(){var n=t.find("#is_open").val(),l="";"False"==n?(n="True",l="标记为已售"):(n="False",l="标记为待售"),t.find("#is_open").val(n),t.find("#open .ui-btn-text").text(l),e.ajax({type:"get",url:"/"+a+"/toggle_post",dataType:"json",data:{wx_id:i,post_id:o,is_open:n}}).then(function(){})},{init:n,showFollowStatus:r,toggleFollowStatus:l,showShareMsg:s,hideShareMsg:d,showPostStatus:showPostStatus,togglePostStatus:togglePostStatus}}(jQuery);$(document).delegate("#sell-detail","pagebeforeshow",function(){detailLoader.init("sell"),gallerySwiper.init($("#sell-detail .gallery"))}),$(document).delegate("#buy-detail","pagebeforeshow",function(){detailLoader.init("buy")}),$(document).delegate("#sell-edit","pagebeforeshow",function(){formLoader.init("sell",$("#sell-edit")),gallerySwiper.init($("#sell-edit .gallery"))}),$(document).delegate("#buy-edit","pagebeforeshow",function(){formLoader.init("buy",$("#buy-edit"))}),$("#sellPostKeyword").keypress(function(e){13==e.which&&toggleKeyword()}),$("#zipcode").keypress(function(e){13==e.which&&toggleLocation()});var userLoader=function(e){var a,t,i={};return i.init=function(i){a=i,t=e("#user-update-page"),t.find("#description").bind("input propertychange",function(){var a=e(this).val().length;t.find("#lengthCounter").html(a+"/3000")});var o=e("#description").val().length,n=o+"/3000";e("#lengthCounter").text(n);var l=!1;e("#post_image").fileupload({url:"/s3/upload/",dataType:"json",done:function(a,t){var i={};i.url=t.result.image_url,i.width=t.result.width,i.height=t.result.height,i.orientation=t.result.orientation,e("#image_url").val(i.url),e("#image_width").val(i.width),e("#image_height").val(i.height),e("#image_orientation").val(i.orientation),e("#profile_image").attr("src",i.url),console.log(JSON.stringify(i))},progressall:function(a,t){var i=parseInt(t.loaded/t.total*100,10);e(".progressbar").show(),jQMProgressBar("progressbar").setValue(i),l=!0,e("#image-uploader").attr("disabled",!0),e("#post_image").attr("disabled",!0)},fail:function(){alert("照片上传出错，请重试一次")},always:function(){e(".progressbar").hide(),l=!1,e("#image-uploader").attr("disabled",!1),e("#post_image").attr("disabled",!1)}})},i}(jQuery);$(document).delegate("#user-update-page","pageinit",function(){userLoader.init("user-update-page")});var addressLoader=function(e){var a,t={};return t.init=function(i){a=e("#"+i),navigator.geolocation?getCurrentPositionDeferred({enableHighAccuracy:!0}).done(function(e){t.getLocationByLatLon(e.coords)}).fail(function(){console.log("getCurrentPosition call failed")}).always(function(){}):console.error("Geolocation is disabled."),e(document).on("click","#getzipcode",function(){var a=e("#zipcode_input").val();a&&e.ajax({type:"get",url:"/user/get_info/get_city_by_zipcode",dataType:"json",data:{zipcode:a}}).then(function(a){console.log(a),e("#city").text(a.city),e("#city_id").val(a.city_id),e("#latitude").val(a.latitude),e("#longitude").val(a.longitude)})})},t.getLocationByLatLon=function(a){var t=a.latitude,i=a.longitude;e.ajax({type:"get",url:"/user/get_info/get_city_by_latlong",dataType:"json",data:{latitude:t,longitude:i}}).then(function(a){e("#city").text(a.city),e("#city_id").val(a.city_id),e("#zipcode").val(a.zipcode),e("#latitude").val(t),e("#longitude").val(i)})},t}(jQuery);$(document).delegate("#user-address-page","pageinit",function(){addressLoader.init("user-address-page")});var infoLoader=function(e){var a,t={};return t.init=function(t){a=e("#"+t)},t}(jQuery);$(document).delegate("#user_info","pageinit",function(){infoLoader.init("user_info")}),$(document).delegate("#user_location","pageinit",function(){addressLoader.init("user_location")});