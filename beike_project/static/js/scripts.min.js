function getCurrentPositionDeferred(e){var i=$.Deferred();return navigator.geolocation.getCurrentPosition(i.resolve,i.reject,e),i.promise()}function formatDistance(e){return e>1e3&&(e=(e/1e3).toFixed(2)+"k"),e}function formatPrice(e){var i=parseFloat(e),a=i.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");return a.indexOf(".")<0&&(a+=".00"),a.indexOf(".")==a.length-2&&(a+="0"),a}function convert_state(e,i){var e=e.toUpperCase(),a=new Array({name:"Alabama",abbrev:"AL"},{name:"Alaska",abbrev:"AK"},{name:"Arizona",abbrev:"AZ"},{name:"Arkansas",abbrev:"AR"},{name:"California",abbrev:"CA"},{name:"Colorado",abbrev:"CO"},{name:"Connecticut",abbrev:"CT"},{name:"Delaware",abbrev:"DE"},{name:"Florida",abbrev:"FL"},{name:"Georgia",abbrev:"GA"},{name:"Hawaii",abbrev:"HI"},{name:"Idaho",abbrev:"ID"},{name:"Illinois",abbrev:"IL"},{name:"Indiana",abbrev:"IN"},{name:"Iowa",abbrev:"IA"},{name:"Kansas",abbrev:"KS"},{name:"Kentucky",abbrev:"KY"},{name:"Louisiana",abbrev:"LA"},{name:"Maine",abbrev:"ME"},{name:"Maryland",abbrev:"MD"},{name:"Massachusetts",abbrev:"MA"},{name:"Michigan",abbrev:"MI"},{name:"Minnesota",abbrev:"MN"},{name:"Mississippi",abbrev:"MS"},{name:"Missouri",abbrev:"MO"},{name:"Montana",abbrev:"MT"},{name:"Nebraska",abbrev:"NE"},{name:"Nevada",abbrev:"NV"},{name:"New Hampshire",abbrev:"NH"},{name:"New Jersey",abbrev:"NJ"},{name:"New Mexico",abbrev:"NM"},{name:"New York",abbrev:"NY"},{name:"North Carolina",abbrev:"NC"},{name:"North Dakota",abbrev:"ND"},{name:"Ohio",abbrev:"OH"},{name:"Oklahoma",abbrev:"OK"},{name:"Oregon",abbrev:"OR"},{name:"Pennsylvania",abbrev:"PA"},{name:"Rhode Island",abbrev:"RI"},{name:"South Carolina",abbrev:"SC"},{name:"South Dakota",abbrev:"SD"},{name:"Tennessee",abbrev:"TN"},{name:"Texas",abbrev:"TX"},{name:"Utah",abbrev:"UT"},{name:"Vermont",abbrev:"VT"},{name:"Virginia",abbrev:"VA"},{name:"Washington",abbrev:"WA"},{name:"West Virginia",abbrev:"WV"},{name:"Wisconsin",abbrev:"WI"},{name:"Wyoming",abbrev:"WY"}),n=!1;return $.each(a,function(a,o){if("name"==i){if(o.abbrev==e)return n=o.name,!1}else if("abbrev"==i&&o.name.toUpperCase()==e)return n=o.abbrev,!1}),n}var a;$.validator.addMethod("digitonly",function(e){return/^\d+$/.test(e)},"只能包含数字");var locUtil=function(e,i){var a=!1,n={latitude:null,longitude:null,city:null,city_id:null,state:null,zipcode:null},o=function(e){console.log(e)},t=function(i){var a=e.Deferred();return navigator.geolocation.getCurrentPosition(a.resolve,a.reject,i),a.promise()},l=function(t,l,r){e.ajax({type:"get",url:"/user/get_info/get_location_by_zipcode",dataType:"json",data:{zipcode:t}}).then(function(e){a=!0,n.zipcode=t,n.city=e.city,n.state=convert_state(e.state,"abbrev"),n.latitude=e.latitude,n.longitude=e.longitude,n.city_id=e.city_id,l&&l.apply!==i?l.apply(null,[n]):o.apply(null,[n])}).fail(function(){a=!1,console.error("getLocation call failed"),r&&r.apply!==i&&r.apply(null)})},r=function(t,l){n.latitude=t.latitude,n.longitude=t.longitude,e.ajax({type:"get",url:"/user/get_info/get_location_by_latlong",dataType:"json",data:{latitude:t.latitude,longitude:t.longitude}}).then(function(e){a=!0,n.city=e.city,n.city_id=e.city_id,n.state=convert_state(e.state,"abbrev"),n.zipcode=e.zipcode,l&&l.apply!==i?l.apply(null,[n]):o.apply(null,[n])}).fail(function(){a=!1})},c=function(e,n){navigator.geolocation?t({enableHighAccuracy:!0}).done(function(i){a=!0,r(i.coords,e)}).fail(function(){a=!1,console.error("getLocation call failed"),n&&n.apply!==i&&n.apply(null)}):console.error("Geolocation is disabled.")},d=function(e,t){a?e&&e.apply!==i?e.apply(null,[n]):o.apply(null,[n]):c(e,t)};return{refreshLocation:c,getLocByZip:l,getLocation:d}}(jQuery),gallerySwiper=function(e){var i,a,n,o,t,l,r,c,d=4,s=500,u=function(){if(1==confirm("要删除该照片吗?")){a--;for(var n=i;a>n;n++)e("#image_url"+n).val(e("#image_url"+(n+1)).val()),e("#image_width"+n).val(e("#image_width"+(n+1)).val()),e("#image_height"+n).val(e("#image_height"+(n+1)).val()),e(t.children(":not(.image-uploader)")[n+1]).attr("onclick","gallerySwiper.select("+n+");");e("#image_url"+a).val(""),e("#image_width"+a).val(""),e("#image_height"+a).val(""),o[0].children[i+1].remove(),t.children(".selected").remove(),i==a&&f(i-1),f(i),p()}},f=function(n){if(n>=0&&a-1>=n){var o=n-i;if(n>i&&a>n)for(var l=0;o>l;l++)v();else if(n>=0&&i>n)for(var l=0;-o>l;l++)h();i=n,e(t.children(":not(.gallery-uploader)").removeClass("selected")[n]).addClass("selected")}},p=function(){0==a||1==a&&!r?e(".gallery-wrapper").addClass("gallery-no-thumbnails"):e(".gallery-wrapper").removeClass("gallery-no-thumbnails"),0==a?e(".gallery-delete").hide():r&&e(".gallery-delete").show()},m=function(i){if(d>a){var n=a,l=i.image_url,r=e('<div class="gallery-thumbnail-box" onclick="gallerySwiper.select('+a+');"><img class="gallery-thumbnail" src="'+l+'" /><div class="gallery-thumbnail-bar"></div></div>'),c=e('<div class="gallery-image-box"><img class="gallery-image" src="'+l+'" /></div>');a++,o.append(c),t.append(r),e("#image_url"+n).val(l),e("#image_width"+n).val(i.width),e("#image_height"+n).val(i.height),f(n),p()}},g=function(a,l,r,c){if(n=o.width()/d,"move"!=l||"left"!=r&&"right"!=r)"cancel"==l?b(n*i,s):"end"==l&&("right"==r?h():"left"==r&&v(),e(t.children(":not(.gallery-uploader)").removeClass("selected")[i]).addClass("selected"));else{var u=0;"left"==r?b(n*i+c,u):"right"==r&&b(n*i-c,u)}},h=function(){i=Math.max(i-1,0),b(o.width()/d*i,s)},v=function(){i=Math.min(i+1,a-1),b(o.width()/d*i,s)},b=function(e,i){o.css("-webkit-transition-duration",(i/1e3).toFixed(1)+"s");var a=(0>e?"":"-")+Math.abs(e).toString();o.css("-webkit-transform","translate3d("+a+"px,0px,0px)")},y={triggerOnTouchEnd:!0,swipeStatus:g,allowPageScroll:"vertical"},w={url:"/s3/upload/",dataType:"json",done:function(e,i){m(i.result)},progressall:function(e,i){var a=parseInt(i.loaded/i.total*100,10);l.attr("disabled","true"),c.css("width",a+"%")},fail:function(){alert("照片上传出错，请重试一次")},always:function(){l.removeAttr("disabled"),c.css("width","0")}},_=function(e){console.log("gallery init"),i=0,n=e.width(),o=e.children(".gallery-list"),t=e.children(".gallery-thumbnail-list"),a=t.children(":not(.gallery-uploader)").length,r=!1,o.hasClass("gallery-canupload")&&(r=!0,l=e.find(".gallery-uploader-input"),c=e.find(".gallery-progressbar"),l.fileupload(w)),(a>1||r)&&o.swipe(y),f(0),p()};return{init:_,select:f,deleteImage:u}}(jQuery),formLocation=function(e){var i,a,n,o,t,l,r,c,d,s,u="加载中...",f="Oops, no locations!",p=function(u){locUtil.getLocation(),i=u,a=i.find("#latitude"),n=i.find("#longitude"),o=i.find("#zipcode"),t=i.find("#city-name"),c=i.find("#city-id"),d=i.find("#form-edit-loc"),s=i.find("#submit_btn"),l=i.find(".form-loc-state1").show(),r=i.find(".form-loc-state2").hide(),locUtil.getLocation(function(e){o.val(e.zipcode),t.val(e.city+", "+e.state),a.val(e.latitude),n.val(e.longitude),c.val(e.city_id),d.attr("onclick","formLocation.changeLocation();"),s.prop("disabled",!1),t.attr("placeholder",f)},function(){o.val(""),t.val(""),a.val(""),n.val(""),c.val(""),d.attr("onclick","formLocation.changeLocation();"),s.prop("disabled",!1),t.attr("placeholder",f)}),o.keypress(function(i){13==i.which&&(i.preventDefault(),e(this).blur(),h())});var p=i.find("#description"),m=i.find("#lengthCounter");m.html(p.val().length+"/300"),p.bind("input propertychange",function(){m.html(p.val().length+"/300")})},m=function(e){l.hide(),r.show(),e||o.focus()},g=function(){t.attr("placeholder",u),d.attr("onclick",""),s.prop("disabled",!0),locUtil.refreshLocation(function(e){o.val(e.zipcode),t.val(e.city+", "+e.state),a.val(e.latitude),n.val(e.longitude),c.val(e.city_id),d.attr("onclick","formLocation.changeLocation();"),s.prop("disabled",!1),t.attr("placeholder",f)},function(){o.val(""),t.val(""),a.val(""),n.val(""),c.val(""),d.attr("onclick","formLocation.changeLocation();"),s.prop("disabled",!1),t.attr("placeholder",f)}),l.show(),r.hide()},h=function(){t.attr("placeholder",u),d.prop("onclick",""),s.prop("disabled",!0),locUtil.getLocByZip(o.val(),function(e){o.val(e.zipcode),t.val(e.city+", "+e.state),a.val(e.latitude),n.val(e.longitude),c.val(e.city_id),d.attr("onclick","formLocation.changeLocation();"),s.prop("disabled",!1),t.attr("placeholder",f)},function(){o.val(""),t.val(""),a.val(""),n.val(""),c.val(""),d.attr("onclick","formLocation.changeLocation();"),s.prop("disabled",!1),t.attr("placeholder",f)}),l.show(),r.hide()};return{init:p,changeLocation:m,refreshLocation:g,getLocationByZipcode:h}}(jQuery),formLoader=function(e){var a,n,o,t=!1,l=!1,r=!1,c=function(i,c){console.log("form init"),a=i,n=c?c:e("#"+a+"-form"),formLocation.init(n),o=n.find("#condition-slider"),f(o.val()),t=!1,l=!1,r=!1;var d={ignore:"#phone_number:hidden, #email:hidden",focusCleanup:!0,rules:{price:"digitonly",phone_number:"digitonly",zipcode:"digitonly"},errorPlacement:function(e,i){i.attr("placeholder",e.html()),i.addClass("hasError");var a=i[0].id;"zipcode"===a?(formLocation.changeLocation(1),i.val(parseInt(i.val())||""),i.attr("data-msg-required",e.html())):("price"===a||"phone_number"===a)&&(i.val(parseInt(i.val())||""),i.attr("data-msg-required",e.html()))}};"buy"===a?n.find("form").validate(d):"sell"===a&&n.find("form").validate(e.extend({submitHandler:function(i){return e(i).valid()&&e("#image_url0").valid()&&i.submit(),!1}},d))},d=function(){l?(n.find("#phone-icon").show(),n.find("#phone-icon-clicked").hide(),l=!1,n.find("#phone-checked").val("off"),r?n.find("#phone_number_div").css("display","block"):n.find("#phone_number_div").css("display","none")):(n.find("#phone-icon").hide(),n.find("#phone-icon-clicked").show(),n.find("#phone_number_div").css("display","block"),l=!0,n.find("#phone-checked").val("on"))},s=function(){t?(n.find("#email-icon").show(),n.find("#email-icon-clicked").hide(),n.find("#email_div").css("display","none"),t=!1,n.find("#email-checked").val("off")):(n.find("#email-icon").hide(),n.find("#email-icon-clicked").show(),n.find("#email_div").css("display","block"),t=!0,n.find("#email-checked").val("on"))},u=function(){r?(n.find("#sms-icon").show(),n.find("#sms-icon-clicked").hide(),l?n.find("#phone_number_div").css("display","block"):n.find("#phone_number_div").css("display","none"),r=!1,e("#sms-checked").val("off")):(n.find("#sms-icon").hide(),n.find("#sms-icon-clicked").show(),n.find("#phone_number_div").css("display","block"),r=!0,n.find("#sms-checked").val("on"))},f=function(e){if(e>=0&&4>e)for(i=0;4>i;i++)i==e?(n.find("#condition-"+i).hide(),n.find("#condition-"+i+"-clicked").show(),n.find("#condition-slider").val(e)):(n.find("#condition-"+i).show(),n.find("#condition-"+i+"-clicked").hide())};return{init:c,clickPhoneContact:d,clickEmailContact:s,clickSmsContact:u,chooseCondition:f}}(jQuery),userLoader=function(e){var i,a,n=function(n){console.log("user loader init"),i=n,a=e("#user-update-page"),formLocation.init(a);var t=a.find(".gallery-uploader-input"),l={url:"/s3/upload/",dataType:"json",done:function(e,i){o(i.result)},progressall:function(){},fail:function(){alert("照片上传出错，请重试一次")},always:function(){t.removeAttr("disabled")}};t.fileupload(l)},o=function(e){var i=e.image_url;a.find(".user-image").attr("src",i),a.find("#image_url").val(i),a.find("#image_width").val(e.width),a.find("#image_height").val(e.height)};return{init:n}}(jQuery),postLoaderConstructor=function(){return function(e,i){var a,n,o,t,l,r,c,d,s,u,f,p,m,g=e(document),h=e(window),v=0,b=null,y=null,w=function(){r.toggleClass("search-extra"),r.hasClass("search-extra")?setTimeout(function(){d.focus()},600):(j(),n.find(".post-ask-location").hide())},_=function(){c.addClass("search-category-on")},L=function(e){c.removeClass("search-category-on"),e&&j()},k=function(i){console.log(i+" init"),a=i,n=e("#nearby-"+a+"post"),o=n.find(".post-list1"),t=n.find(".post-list2"),l=n.find(".post-load-more").show(),d=n.find("#zipcode"),s=n.find("#searchKeyword"),r=n.find(".search-bar"),c=n.find(".search-category-box"),f=n.find(".num-per-page").val(),C(),p=!0,locUtil.getLocation(function(e){d.val(e.zipcode),m=e,x()},function(){C(),w(),l.hide(),n.find(".post-ask-location").show()}),e(document).on("scrollstop",function(){e(".ui-page-active")[0].id==="nearby-"+a+"post"&&h.scrollTop()>=g.height()-h.height()-200&&x()}),d.keypress(function(i){13==i.which&&(w(),e(this).blur())}),s.keypress(function(i){13==i.which&&(L(1),e(this).blur())}),n.find(".ui-radio").on("click",function(){s.focus()})},C=function(){slot_pos=0,u=1,p=!0,o.empty(),t.empty()},x=function(){p&&"undefined"!=typeof m&&$()},$=function(){return e.ajax({type:"get",url:"/"+a+"/get_posts_by_page",dataType:"json",data:{pageNum:u,latitude:m.latitude,longitude:m.longitude,category:b,keyword:y}}).then(function(e){M(e)})},M=function(r){var c=e(""),d=e(""),s=0,m=r.length;for(f>m?(p=!1,l.hide()):(p=!0,u++),s=0;m>s;s++){var g,h,b,y=formatDistance(r[s].distance);if("sell"===a){if(h=jQuery.parseJSON(r[s].image_info),!(h.length>0)){image_info=i;continue}image_info=h[0],b='<img class="post-image" src="'+image_info.image_url+'" />',g=formatPrice(r[s].price)}else"buy"===a&&(b="",g=formatPrice(r[s].max_price));b='<div class="post-item-box"><a class="post-item" onmousedown="'+a+"PostLoader.loadPage("+r[s].post_id+');" onmouseup="'+a+"PostLoader.changePage("+r[s].post_id+');"><div><img class="post-icon" src="/static/images/general/'+a+'_icon_40.png" /><span class="post-title">'+r[s].title+"</span></div>"+b+'<div class="post-price"><span class="post-currency">$&nbsp;</span>'+g+'</div><div class="post-distance">距离你 '+y+" miles</div></a></div>",v%2===0?c.after(e(b)):d.after(e(b)),v++}o.append(c),t.append(d),o.is(":empty")&&t.is(":empty")?n.find(".post-empty").show():n.find(".post-empty").hide()},P=function(){},S=function(i){L(0),e("body").pagecontainer("change","/detail/"+a+"/"+i)},j=function(){b=n.find('input[name="category"]:checked').val(),y=s.val(),locUtil.getLocByZip(d.val(),function(e){m=e,C(),x()},function(){C(),w(),l.hide(),n.find(".post-ask-location").show()})};return{init:k,refreshPosts:j,loadPage:P,changePage:S,toggleExtra:w,showCategory:_,hideCategory:L}}(jQuery)},buyPostLoader=postLoaderConstructor(),sellPostLoader=postLoaderConstructor(),detailLoader=function(e){var i,a,n,o,t=function(e,t){i=e,a=t,n=a.find("#wx_id").val(),o=a.find("#post_id").val();var l=a.find(".detail-price");l.html(formatPrice(l.html())),r(),s()},l=function(){var t=a.find("#is_followed").val(),l="",r="";"False"==t?(t="True",l="/static/images/detail/followed.png",r="<p>关注本帖!</p>"):(t="False",r="<p>取消关注！</p>",l="/static/images/detail/not_followed.png"),a.find("#is_followed").val(t),a.find("#follow").attr("src",l),e.ajax({type:"get",url:"/"+i+"/follow_post",dataType:"json",data:{wx_id:n,post_id:o,is_followed:t}}).then(function(){})},r=function(){var e=a.find("#is_followed").val();"False"==e?a.find("#follow").attr("src","/static/images/detail/not_followed.png"):a.find("#follow").attr("src","/static/images/detail/followed.png")},c=function(){a.find("#share_msg").show()},d=function(){a.find("#share_msg").hide()},s=function(){var e=a.find("#is_open").val();a.find("#open .ui-btn-text").text("False"==e?"标记为待售":"标记为已售")},u=function(){var t=a.find("#is_open").val(),l="";"False"==t?(t="True",l="标记为已售"):(t="False",l="标记为待售"),a.find("#is_open").val(t),a.find("#open .ui-btn-text").text(l),e.ajax({type:"get",url:"/"+i+"/toggle_post",dataType:"json",data:{wx_id:n,post_id:o,is_open:t}}).then(function(){})};return{init:t,showFollowStatus:r,toggleFollowStatus:l,showShareMsg:c,hideShareMsg:d,showPostStatus:s,togglePostStatus:u}}(jQuery);$(document).on("pagebeforeshow",function(){var e=navigator.userAgent.toLowerCase();"micromessenger"!=e.match(/MicroMessenger/i)&&$(".header").show()}),$(document).on("pagebeforeshow","#main",function(){locUtil.getLocation(function(e){$(".main-city-text").html(e.city)},function(){$(".main-city-text").html("获取位置")})}),$(document).on("pageshow","#buy-form",function(){}),$(document).on("pagebeforeshow","#buy-form",function(){formLoader.init("buy")}),$(document).on("pagebeforeshow","#sell-form",function(){formLoader.init("sell"),gallerySwiper.init($("#sell-form-gallery"))}),$(document).on("pagebeforeshow","#buy-edit",function(){formLoader.init("buy",$("#buy-edit"))}),$(document).on("pagebeforeshow","#sell-edit",function(){formLoader.init("sell",$("#sell-edit")),gallerySwiper.init($("#sell-edit-gallery"))}),$(document).on("pagebeforeshow","#sell-detail",function(){detailLoader.init("sell",$(this)),gallerySwiper.init($(this).find(".gallery"))}),$(document).on("pagebeforeshow","#buy-detail",function(){detailLoader.init("buy",$(this))}),$(document).on("pageinit","#nearby-buypost",function(){buyPostLoader.init("buy")}),$(document).on("pageinit","#nearby-sellpost",function(){sellPostLoader.init("sell")}),$(document).on("pagebeforeshow","#user-update-page",function(){userLoader.init("user-update-page")}),$(document).on("pagebeforeshow",function(){$(".refresh-title")[0].contentWindow.location.reload()});