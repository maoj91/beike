<!DOCTYPE HTML>
<html lang="zh">

{% include "head.html" %}

<body>
<div data-role="page" id="sell-detail-page" data-fullscreen="true">
    {% include "header.html" with title="物品" %}

    <div data-role="content">
        <div class="detail-title-wrapper">
            <img class="detail-icon" src='/static/images/detail/sell_icon.png'>
            <div class="detail-title">{{post.title}}</div>

            <img id="share" class="share-button" src="/static/images/detail/share.png" onclick="showShareMsg();"> 
            <img id="follow" class="share-button" onclick="toggleFollowStatus();"> 
        </div>

        <!-- TODO: needs to clean up -->
        <hr>
        <img id="share_msg" src="/static/images/detail/share_msg.png" style="display:none;width:100%;height:100%;position:absolute;left:0;top:0;z-index:1;" onclick="hideShareMsg()">
        <div id="image_gallery">
            <div id="imgs">
                {% for image_metadata in image_list %}
                <span class="img_span">
                    <img src="{{ image_metadata.image_url }}">
                </span>
                {% endfor%}
            </div>
        </div>   
        <div id="image_thumbnails">
            {% for image_metadata in image_list %}
            <span class="thumbnail_span" id="thumbnail_span{{forloop.counter0}}" onclick='selectImage({{forloop.counter0}})'>
                <img src="{{ image_metadata.image_url }}">
            </span>
            {% endfor%}
        </div>
        <hr>
        
        
        <div class="detail-price">
            <span class="detail-currency">$&nbsp;</span>{{post.price}}

            {% if post.item_condition.name == 'Condition1' %}
                全新
            {% elif post.item_condition.name == 'Condition2' %}
                九成新
            {% elif post.item_condition.name == 'Condition3' %}
                七成新
            {% elif post.item_condition.name == 'Condition4' %}
                五成新
            {% elif post.item_condition.name == 'Condition5' %}
                旧
            {% endif %}
        </div>
        <div class="detail-category">
            <span class="detail-postdate">{{ post.date_published|date:"n月j日" }},</span>
             {{post.category.name}}
        </div>

        <div class="detail-content">{{post.content}}</div>

        <div class="detail-map">
            <img id="map" src="">
            <div class="detail-loc">
                <!--img class="city-mark" src="/static/images/detail/location_icon.png"-->
                <span class="city-text">{{post.user.address.city}}</span>
            </div>
        </div>

<!-- TODO: what's this? -->
<!--div class="ui-grid-b" style="margin-top:10px;">
<div class="ui-block-b" style="width:50%">
<a href="#seller"><img src='/static/images/detail/contact_seller.png' style="vertical-align:middle;max-height:35px;"></a>
</div>
</div-->

        <div class="detail-contacts">
        {% if email_checked%}
            <a class="detail-contact-link" href="mailto:{{email}}?Subject={{post.title}}"><img class="detail-contact-icon" src="/static/images/detail/email_selected.png"/></a>
        {% endif%}
        {% if phone_checked%}
            <a class="detail-contact-link" href="tel:{{phone}}"><img class="detail-contact-icon" src="/static/images/detail/phone_selected.png" /></a>
        {% endif%}
        {% if sms_checked%}
            <a class="detail-contact-link" href="sms:{{phone}}"><img class="detail-contact-icon" src="/static/images/detail/sms_selected.png" /></a>
        {% endif%}
        </div>

        <!-- TODO: needs to clean up -->
        {% if user_image %}
        <div style="display:table;margin:0 auto;">
            <a href="/user/{{post.user.id}}/">
                <img id='profile_image' src='{{user_image.image_url}}' style="width: 80px;height:80px;border-radius: 50%;"/>
            </a>  
        </div>
        {% endif %}

        <!-- TODO: needs to clean up -->
        {% if post.user %}
        <div style="text-align:center;padding:2px;">
            <p style="display:inline;vertical-align:middle;font:20px arial,sans-serif;">{{post.user.name}}</p>
        </div>
        {% endif %} 

        <!-- TODO: needs to clean up -->
        {% if post.user.description %}
        <div class="ui-grid-solo" id="user_description" style="margin-bottom:20px;margin-top:20px;margin-left:5%;margin-right:5%;">
            {{post.user.description}}
        </div>
        {% endif %}

        <!-- TODO: what's this? -->
        <a name="seller"></a>

        <!-- TODO: needs to clean up -->
        <div class="ui-grid-solo" style="clear:both;margin-top:20px;padding:5px 5% 5px 5%;background-color:#d1cfd1;text-align:center;">
            注册于{{ post.user.date_created|date:"Y年n月j日" }}
        </div>

        <!-- TODO: needs to clean up -->
        <div class="ui-grid-solo" style="clear:both;margin-top:20px;margin-bottom:20px;float:right;">
            <a href="/user/{{user_id}}/">
                <img src="/static/images/detail/complete_profile.png" style="max-height:30px;">
            </a>
        </div>
    </div>
    
<!-- TODO: what's this? -->
<!--                 <div class="ui-block-a" style="width:33%;height:60px;">
                    <span class="helper" style="display:inline-block;height:100%;vertical-align: middle;"></span>
                    <select name="open-close-post" id="open-close-post" data-role="slider" style="vertical-align: middle;">
                        <option value="open"{% if is_open %} selected {% endif %}>待售</option>
                        <option value="close"{% if not is_open %} selected {% endif %}>已售</option>
                    </select>
                </div> -->

    <!-- TODO: needs to clean up -->
    {% if is_owner %}
    <!-- find this post about how to align an element vertically center in a div: http://stackoverflow.com/questions/7273338/how-to-vertically-align-an-image-inside-div-->
    <div class="ui-grid-solo" style="width:100%;padding-top:15px;padding-bottom:15px;background-color:#d1cfd1;height:60px;text-align:center;display:inline-block;vertical-align: middle;">
        <span class="helper" style="display:inline-block;height:100%;vertical-align: middle;"></span>
        <a href="/detail/sell/{{post.id}}/edit/"><input type="image" value="修改" id="edit_btn" src="/static/images/detail/edit.png" style="max-width:80px;vertical-align: middle;"></a>
    </div>
    {% endif %}

    <img id="share_msg" src="/static/images/detail/share_msg.png" style="display:none;width:100%;max-height:100%;position:absolute;left:0;top:0;z-index:1;background-color:black;opacity: 0.6;" onclick="hideShareMsg()">

    <div style="margin-left:5%;margin-right:5%;">
        <div data-role="popup" id="follow-popup"></div>
    </div>
    <input type="hidden" id="is_followed" value="{{is_followed}}">
    <input type="hidden" id="post_id" value="{{post.id}}">
    <input type="hidden" id="wx_id" value="{{wx_id}}">

{% include "footer.html" %}
</div>

<!-- TODO: needs to clean up -->
<script id='code_1'>
                var IMG_WIDTH = (window.innerWidth > 0) ? window.innerWidth : screen.width;
                var currentImg=0;
                var maxImages={{image_num}};
                var speed=500;

                var imgs;

                var swipeOptions=
                {
                    triggerOnTouchEnd : true,   
                    swipeStatus : swipeStatus,
                    allowPageScroll:"vertical",
                    threshold:75            
                }

                $(function()
                {               
                    imgs = $("#imgs");
                    imgs.swipe( swipeOptions );
                });


                /**
                * Catch each phase of the swipe.
                * move : we drag the div.
                * cancel : we animate back to where we were
                * end : we animate to the next image
                */          
                function swipeStatus(event, phase, direction, distance)
                {
                    //If we are moving before swipe, and we are going Lor R in X mode, or U or D in Y mode then drag.
                    if( phase=="move" && (direction=="left" || direction=="right") )
                    {
                        var duration=0;

                        if (direction == "left")
                            scrollImages((IMG_WIDTH * currentImg) + distance, duration);

                        else if (direction == "right")
                            scrollImages((IMG_WIDTH * currentImg) - distance, duration);

                    }

                    else if ( phase == "cancel")
                    {
                        scrollImages(IMG_WIDTH * currentImg, speed);
                    }

                    else if ( phase =="end" )
                    {
                        if (direction == "right")
                            previousImage()
                        else if (direction == "left")           
                            nextImage()
                    }
                }

                function selectImage(i){
                    var diff = i - currentImg;
                    if(i>currentImg && i<=maxImages-1){
                        for(var j=0;j<diff;j++){
                            nextImage();
                        }
                    } else if(i>=0 && i<currentImg){
                        for(var j=0;j<-diff;j++){
                            previousImage();
                        }
                    }
                }

                function selectThumbnail(i){
                    if(i>=0 && i<=maxImages-1){
                        for(var j=0;j<=maxImages-1;j++){
                            $("#thumbnail_span"+j).addClass("thumbnail_not_selected");
                        }
                        $("#thumbnail_span"+i).removeClass("thumbnail_not_selected");
                        $("#thumbnail_span"+i).addClass("thumbnail_selected");
                    }
                }

                function previousImage()
                {
                    currentImg = Math.max(currentImg-1, 0);
                    scrollImages( IMG_WIDTH * currentImg, speed);
                    selectThumbnail(currentImg);
                }

                function nextImage()
                {
                    currentImg = Math.min(currentImg+1, maxImages-1);
                    scrollImages( IMG_WIDTH * currentImg, speed);
                    selectThumbnail(currentImg);
                }

                /**
                * Manuallt update the position of the imgs on drag
                */
                function scrollImages(distance, duration)
                {
                    imgs.css("-webkit-transition-duration", (duration/1000).toFixed(1) + "s");

                    //inverse the number we set in the css
                    var value = (distance<0 ? "" : "-") + Math.abs(distance).toString();

                    imgs.css("-webkit-transform", "translate3d("+value +"px,0px,0px)");
                }
                </script>


<script type="text/javascript">
var wx_id = $("#wx_id").val();
var post_id = $("#post_id").val();

$("#open-close-post").on('slidestop', function(event) {
    var operation = $("#open-close-post").val();
    return $.ajax({
        type: "get",
        url: "/sell/open_close_post",
        dataType: "json",
        data: {
            wx_id: wx_id,
            post_id: post_id,
            operation: operation
        }
    }).then(function(data) {});
});

function toggleFollowStatus(){
    var is_followed = $("#is_followed").val(); 
    var follow_img = '';   
    var popup_msg = '';
    if( is_followed == "False"){
        is_followed = "True";
        follow_img = '/static/images/detail/followed.png';
        popup_msg = '<p>关注本帖!</p>';
    } else {
        is_followed = "False";
        popup_msg = '<p>取消关注！</p>';
        follow_img = '/static/images/detail/not_followed.png';
    }
    $("#is_followed").val(is_followed);
    $("#follow").attr("src", follow_img);
    $('#follow-popup').html(popup_msg);
    $('#follow-popup').popup("open");
    setTimeout(function() {
      $('#follow-popup').popup("close");
    }, 1000);
    $.ajax({
        type: "get",
        url: "/sell/follow_post",
        dataType: "json",
        data: {
            wx_id: wx_id,
            post_id: post_id,
            is_followed: is_followed
        }
    }).then(function(data) {
        
    });
}

function sendEmail(email, title){
    window.location.assign("mailto:"+email+"?Subject=回复帖子:"+title);
    // alert(email+","+title);
}

function showFollowStatus() {
    var is_followed = $("#is_followed").val();
    if( is_followed === "False"){
        $("#follow").attr("src", '/static/images/detail/not_followed.png');
    } else {
        $("#follow").attr("src", '/static/images/detail/followed.png');
    }
}

function showPosition() {
    var latlonStr = "{{lat}}"+","+"{{lon}}";
    var width = 640; //(window.innerWidth > 0) ? window.innerWidth : screen.width;
    var height = 200;
    var img_url = "http://maps.googleapis.com/maps/api/staticmap?center="+latlonStr+"&zoom=14&size="+width+"x"+height+"&sensor=true&markers=color:green%7C"+latlonStr;
    $("#map").attr("src",img_url);
    return img_url;
}

function showShareMsg(){
    $("#share_msg").show();
}

function hideShareMsg(){
    $("#share_msg").hide();
}


$(document).ready(function() {
    selectThumbnail(0);
    showPosition();
    showFollowStatus();
});
</script>
</body>
</html>
